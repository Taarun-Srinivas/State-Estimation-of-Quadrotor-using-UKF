 function [covarEst,uEst] = pred_step(uPrev,covarPrev,angVel,acc,dt)
%covarPrev and uPrev are the previous mean and covariance respectively
%angVel is the angular velocity
%acc is the acceleration
%dt is the sampling time

pd = uPrev(7:9);
q =  uPrev(4:6);
gb = uPrev(10:12);
ab = uPrev(13:15);

gn = [normrnd(0,0); normrnd(0,0); normrnd(0,0)]; % Gyro noise
an = [normrnd(0,0); normrnd(0,0); normrnd(0,0)]; % Accelerometer noise

gbn = [normrnd(0,0); normrnd(0,0); normrnd(0,0)]; %gyro bias noise
abn = [normrnd(0,0); normrnd(0,0); normrnd(0,0)]; %acc bias noise

R = [cos(q(2))*cos(q(3)) cos(q(3))*sin(q(1))*sin(q(2))-cos(q(1))*sin(q(3)) sin(q(1))*sin(q(3))+cos(q(1))*cos(q(3))*sin(q(2));
     cos(q(2))*sin(q(3)) cos(q(1))*cos(q(3))+sin(q(1))*sin(q(2))*sin(q(3)) cos(q(1))*sin(q(2))*sin(q(3))-cos(q(3))*sin(q(1));
     -sin(q(2)) cos(q(2))*sin(q(1)) cos(q(1))*cos(q(2))];

G = [0 -sin(q(3)) cos(q(2))*cos(q(3));
     0  cos(q(3)) cos(q(2))*sin(q(3));
     1 0 -sin(q(2))];

xd = [pd;
      R*inv(G)*(angVel - gb - gn);
      [0;0;-9.81] + R*(acc - ab - an);
      gbn;
      abn];

Q = diag([0.01 0.01 0.01 25 25 25 10 10 10 0.1 0.1 0.1 0.1 0.1 0.1]);
 
At = [0, 0, 0,                                                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   0, 1, 0, 0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0,                0,                                           0,                                           0;
0, 0, 0,                                                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   0, 0, 1, 0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0,                0,                                           0,                                           0;
0, 0, 0,                                                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   0, 0, 0, 1,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0,                0,                                           0,                                           0;
0, 0, 0, ((gb(1) + gn(1) - angVel(1))*(cos(q(2))*sin(q(1))*sin(q(3))^2 + cos(q(3))^2*sin(q(1))*sin(q(2)) - cos(q(1))*cos(q(3))*sin(q(3)) + cos(q(1))*cos(q(2))*cos(q(3))*sin(q(2))*sin(q(3))))/cos(q(2)) - ((gb(2) + gn(2) - angVel(2))*(cos(q(1))*sin(q(3))^2 + cos(q(1))*cos(q(2))*cos(q(3))^2*sin(q(2)) + cos(q(2))*cos(q(3))*sin(q(1))*sin(q(3)) - cos(q(3))*sin(q(1))*sin(q(2))*sin(q(3))))/cos(q(2)),                                                                                                 -(gb(1)*cos(q(2))^3*cos(q(3))^2 + gn(1)*cos(q(2))^3*cos(q(3))^2 - angVel(1)*cos(q(2))^3*cos(q(3))^2 + gb(2)*sin(q(1))*sin(q(2)) + gn(2)*sin(q(1))*sin(q(2)) - angVel(2)*sin(q(1))*sin(q(2)) + gb(1)*cos(q(1))*cos(q(3))^2 + gn(1)*cos(q(1))*cos(q(3))^2 - angVel(1)*cos(q(1))*cos(q(3))^2 + gb(2)*cos(q(2))^3*cos(q(3))^2*sin(q(1)) + gn(2)*cos(q(2))^3*cos(q(3))^2*sin(q(1)) - angVel(2)*cos(q(2))^3*cos(q(3))^2*sin(q(1)) + gb(2)*cos(q(1))*cos(q(3))*sin(q(3)) + gn(2)*cos(q(1))*cos(q(3))*sin(q(3)) - angVel(2)*cos(q(1))*cos(q(3))*sin(q(3)) - gb(3)*cos(q(2))^2*cos(q(3))*sin(q(2)) + gb(2)*cos(q(2))^3*cos(q(3))*sin(q(3)) - gn(3)*cos(q(2))^2*cos(q(3))*sin(q(2)) + gn(2)*cos(q(2))^3*cos(q(3))*sin(q(3)) - gb(2)*cos(q(3))^2*sin(q(1))*sin(q(2)) + angVel(3)*cos(q(2))^2*cos(q(3))*sin(q(2)) - angVel(2)*cos(q(2))^3*cos(q(3))*sin(q(3)) - gn(2)*cos(q(3))^2*sin(q(1))*sin(q(2)) + angVel(2)*cos(q(3))^2*sin(q(1))*sin(q(2)) + gb(1)*cos(q(3))*sin(q(1))*sin(q(2))*sin(q(3)) + gn(1)*cos(q(3))*sin(q(1))*sin(q(2))*sin(q(3)) - angVel(1)*cos(q(3))*sin(q(1))*sin(q(2))*sin(q(3)) - gb(1)*cos(q(2))^3*cos(q(3))*sin(q(1))*sin(q(3)) - gn(1)*cos(q(2))^3*cos(q(3))*sin(q(1))*sin(q(3)) + angVel(1)*cos(q(2))^3*cos(q(3))*sin(q(1))*sin(q(3)))/cos(q(2))^2,   cos(q(2))*sin(q(3))*(gb(3) + gn(3) - angVel(3)) - ((gb(2) + gn(2) - angVel(2))*(cos(q(1))*cos(q(2)) - cos(q(1))*sin(q(2)) - cos(q(2))*sin(q(2)) - 2*cos(q(1))*cos(q(2))*cos(q(3))^2 + 2*cos(q(1))*cos(q(3))^2*sin(q(2)) + 2*cos(q(2))*cos(q(3))^2*sin(q(2)) + 2*cos(q(3))*sin(q(1))*sin(q(3)) - 2*cos(q(2))*cos(q(3))*sin(q(1))*sin(q(2))*sin(q(3))))/cos(q(2)) + ((gb(1) + gn(1) - angVel(1))*(sin(q(1)) - 2*cos(q(3))^2*sin(q(1)) - cos(q(2))*sin(q(1))*sin(q(2)) + 2*cos(q(2))*cos(q(3))^2*sin(q(1))*sin(q(2)) - 2*cos(q(1))*cos(q(2))*cos(q(3))*sin(q(3)) + 2*cos(q(1))*cos(q(3))*sin(q(2))*sin(q(3)) + 2*cos(q(2))*cos(q(3))*sin(q(2))*sin(q(3))))/cos(q(2)), 0, 0, 0,      -(cos(q(1))*cos(q(2))*sin(q(3))^2 + cos(q(1))*cos(q(3))^2*sin(q(2)) + cos(q(2))*cos(q(3))^2*sin(q(2)) + cos(q(3))*sin(q(1))*sin(q(3)) - cos(q(2))*cos(q(3))*sin(q(1))*sin(q(2))*sin(q(3)))/cos(q(2)),             -(sin(q(1))*sin(q(3))^2 + cos(q(2))*cos(q(3))^2*sin(q(1))*sin(q(2)) - cos(q(1))*cos(q(2))*cos(q(3))*sin(q(3)) + cos(q(1))*cos(q(3))*sin(q(2))*sin(q(3)) + cos(q(2))*cos(q(3))*sin(q(2))*sin(q(3)))/cos(q(2)), -cos(q(2))*cos(q(3)),                0,                                           0,                                           0;
0, 0, 0, ((gb(1) + gn(1) - angVel(1))*(cos(q(1))*cos(q(3))^2 + cos(q(1))*cos(q(2))*sin(q(2))*sin(q(3))^2 - cos(q(2))*cos(q(3))*sin(q(1))*sin(q(3)) + cos(q(3))*sin(q(1))*sin(q(2))*sin(q(3))))/cos(q(2)) + ((gb(2) + gn(2) - angVel(2))*(cos(q(2))*cos(q(3))^2*sin(q(1)) + sin(q(1))*sin(q(2))*sin(q(3))^2 + cos(q(1))*cos(q(3))*sin(q(3)) - cos(q(1))*cos(q(2))*cos(q(3))*sin(q(2))*sin(q(3))))/cos(q(2)), -(gn(2)*cos(q(2))^3 - angVel(2)*cos(q(2))^3 + gb(2)*cos(q(1)) + gn(2)*cos(q(1)) - angVel(2)*cos(q(1)) + gb(2)*cos(q(2))^3 - gb(2)*cos(q(2))^3*cos(q(3))^2 - gn(2)*cos(q(2))^3*cos(q(3))^2 + angVel(2)*cos(q(2))^3*cos(q(3))^2 - gb(2)*cos(q(1))*cos(q(3))^2 - gn(2)*cos(q(1))*cos(q(3))^2 - gb(1)*cos(q(2))^3*sin(q(1)) + angVel(2)*cos(q(1))*cos(q(3))^2 - gn(1)*cos(q(2))^3*sin(q(1)) + angVel(1)*cos(q(2))^3*sin(q(1)) + gb(1)*cos(q(2))^3*cos(q(3))^2*sin(q(1)) + gn(1)*cos(q(2))^3*cos(q(3))^2*sin(q(1)) - angVel(1)*cos(q(2))^3*cos(q(3))^2*sin(q(1)) + gb(1)*cos(q(1))*cos(q(3))*sin(q(3)) + gn(1)*cos(q(1))*cos(q(3))*sin(q(3)) - angVel(1)*cos(q(1))*cos(q(3))*sin(q(3)) + gb(1)*cos(q(2))^3*cos(q(3))*sin(q(3)) + gn(1)*cos(q(2))^3*cos(q(3))*sin(q(3)) - gb(1)*cos(q(3))^2*sin(q(1))*sin(q(2)) - gb(3)*cos(q(2))^2*sin(q(2))*sin(q(3)) - angVel(1)*cos(q(2))^3*cos(q(3))*sin(q(3)) - gn(1)*cos(q(3))^2*sin(q(1))*sin(q(2)) - gn(3)*cos(q(2))^2*sin(q(2))*sin(q(3)) + angVel(1)*cos(q(3))^2*sin(q(1))*sin(q(2)) + angVel(3)*cos(q(2))^2*sin(q(2))*sin(q(3)) - gb(2)*cos(q(3))*sin(q(1))*sin(q(2))*sin(q(3)) - gn(2)*cos(q(3))*sin(q(1))*sin(q(2))*sin(q(3)) + angVel(2)*cos(q(3))*sin(q(1))*sin(q(2))*sin(q(3)) + gb(2)*cos(q(2))^3*cos(q(3))*sin(q(1))*sin(q(3)) + gn(2)*cos(q(2))^3*cos(q(3))*sin(q(1))*sin(q(3)) - angVel(2)*cos(q(2))^3*cos(q(3))*sin(q(1))*sin(q(3)))/cos(q(2))^2, - cos(q(2))*cos(q(3))*(gb(3) + gn(3) - angVel(3)) - ((gb(1) + gn(1) - angVel(1))*(cos(q(1))*cos(q(2)) - cos(q(1))*sin(q(2)) - cos(q(2))*sin(q(2)) - 2*cos(q(1))*cos(q(2))*cos(q(3))^2 + 2*cos(q(1))*cos(q(3))^2*sin(q(2)) + 2*cos(q(2))*cos(q(3))^2*sin(q(2)) + 2*cos(q(3))*sin(q(1))*sin(q(3)) - 2*cos(q(2))*cos(q(3))*sin(q(1))*sin(q(2))*sin(q(3))))/cos(q(2)) - ((gb(2) + gn(2) - angVel(2))*(sin(q(1)) - 2*cos(q(3))^2*sin(q(1)) - cos(q(2))*sin(q(1))*sin(q(2)) + 2*cos(q(2))*cos(q(3))^2*sin(q(1))*sin(q(2)) - 2*cos(q(1))*cos(q(2))*cos(q(3))*sin(q(3)) + 2*cos(q(1))*cos(q(3))*sin(q(2))*sin(q(3)) + 2*cos(q(2))*cos(q(3))*sin(q(2))*sin(q(3))))/cos(q(2)), 0, 0, 0, (cos(q(3))^2*sin(q(1)) + cos(q(2))*sin(q(1))*sin(q(2))*sin(q(3))^2 + cos(q(1))*cos(q(2))*cos(q(3))*sin(q(3)) - cos(q(1))*cos(q(3))*sin(q(2))*sin(q(3)) - cos(q(2))*cos(q(3))*sin(q(2))*sin(q(3)))/cos(q(2)), -(cos(q(2))*sin(q(2)) + cos(q(1))*cos(q(2))*cos(q(3))^2 - cos(q(2))*cos(q(3))^2*sin(q(2)) + cos(q(1))*sin(q(2))*sin(q(3))^2 - cos(q(3))*sin(q(1))*sin(q(3)) + cos(q(2))*cos(q(3))*sin(q(1))*sin(q(2))*sin(q(3)))/cos(q(2)), -cos(q(2))*sin(q(3)),                0,                                           0,                                           0;
0, 0, 0,                                                                                                                                                                                     (cos(q(3))*sin(q(1)) + cos(q(1))*cos(q(2))*sin(q(3)))*(gb(1) + gn(1) - angVel(1)) + (sin(q(1))*sin(q(3)) - cos(q(1))*cos(q(2))*cos(q(3)))*(gb(2) + gn(2) - angVel(2)),                                                                                                                                                                                                                                                                                                                                                                                                                                (gn(3)*cos(q(2))^3 - angVel(3)*cos(q(2))^3 + gb(3)*cos(q(2))^3 + gb(1)*cos(q(3))*sin(q(2)) + gn(1)*cos(q(3))*sin(q(2)) + gb(2)*sin(q(2))*sin(q(3)) - angVel(1)*cos(q(3))*sin(q(2)) + gn(2)*sin(q(2))*sin(q(3)) - angVel(2)*sin(q(2))*sin(q(3)) + gb(1)*cos(q(2))^2*cos(q(3))*sin(q(2)) + gn(1)*cos(q(2))^2*cos(q(3))*sin(q(2)) + gb(2)*cos(q(2))^2*sin(q(2))*sin(q(3)) - angVel(1)*cos(q(2))^2*cos(q(3))*sin(q(2)) + gn(2)*cos(q(2))^2*sin(q(2))*sin(q(3)) - angVel(2)*cos(q(2))^2*sin(q(2))*sin(q(3)) + gb(2)*cos(q(2))^2*cos(q(3))*sin(q(1))*sin(q(2)) + gn(2)*cos(q(2))^2*cos(q(3))*sin(q(1))*sin(q(2)) - gb(1)*cos(q(2))^2*sin(q(1))*sin(q(2))*sin(q(3)) - angVel(2)*cos(q(2))^2*cos(q(3))*sin(q(1))*sin(q(2)) - gn(1)*cos(q(2))^2*sin(q(1))*sin(q(2))*sin(q(3)) + angVel(1)*cos(q(2))^2*sin(q(1))*sin(q(2))*sin(q(3)))/cos(q(2))^2,                                                                                                                                                                                                                                                                                                   ((gb(2) + gn(2) - angVel(2))*(cos(q(3)) - cos(q(2))^2*cos(q(3)) + cos(q(2))^2*sin(q(1))*sin(q(3)) - cos(q(1))*cos(q(2))*cos(q(3))))/cos(q(2)) + ((gb(1) + gn(1) - angVel(1))*(cos(q(2))^2*sin(q(3)) - sin(q(3)) + cos(q(2))^2*cos(q(3))*sin(q(1)) + cos(q(1))*cos(q(2))*sin(q(3))))/cos(q(2)), 0, 0, 0,                                                                           (cos(q(3)) - cos(q(2))^2*cos(q(3)) + cos(q(2))^2*sin(q(1))*sin(q(3)) - cos(q(1))*cos(q(2))*cos(q(3)))/cos(q(2)),                                                                                       -(cos(q(2))^2*sin(q(3)) - sin(q(3)) + cos(q(2))^2*cos(q(3))*sin(q(1)) + cos(q(1))*cos(q(2))*sin(q(3)))/cos(q(2)),          sin(q(2)),                0,                                           0,                                           0;
0, 0, 0,                                                                                                                                                                                   - (sin(q(1))*sin(q(3)) + cos(q(1))*cos(q(3))*sin(q(2)))*(ab(2) - acc(2) + an(2)) - (cos(q(1))*sin(q(3)) - cos(q(3))*sin(q(1))*sin(q(2)))*(ab(3) - acc(3) + an(3)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    cos(q(3))*sin(q(2))*(ab(1) - acc(1) + an(1)) - cos(q(1))*cos(q(2))*cos(q(3))*(ab(3) - acc(3) + an(3)) - cos(q(2))*cos(q(3))*sin(q(1))*(ab(2) - acc(2) + an(2)),                                                                                                                                                                                                                                                                                                                                                                   (cos(q(1))*cos(q(3)) + sin(q(1))*sin(q(2))*sin(q(3)))*(ab(2) - acc(2) + an(2)) - (cos(q(3))*sin(q(1)) - cos(q(1))*sin(q(2))*sin(q(3)))*(ab(3) - acc(3) + an(3)) + cos(q(2))*sin(q(3))*(ab(1) - acc(1) + an(1)), 0, 0, 0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0, -cos(q(2))*cos(q(3)),   cos(q(1))*sin(q(3)) - cos(q(3))*sin(q(1))*sin(q(2)), - sin(q(1))*sin(q(3)) - cos(q(1))*cos(q(3))*sin(q(2));
0, 0, 0,                                                                                                                                                                                     (cos(q(3))*sin(q(1)) - cos(q(1))*sin(q(2))*sin(q(3)))*(ab(2) - acc(2) + an(2)) + (cos(q(1))*cos(q(3)) + sin(q(1))*sin(q(2))*sin(q(3)))*(ab(3) - acc(3) + an(3)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    sin(q(2))*sin(q(3))*(ab(1) - acc(1) + an(1)) - cos(q(1))*cos(q(2))*sin(q(3))*(ab(3) - acc(3) + an(3)) - cos(q(2))*sin(q(1))*sin(q(3))*(ab(2) - acc(2) + an(2)),                                                                                                                                                                                                                                                                                                                                                                   (cos(q(1))*sin(q(3)) - cos(q(3))*sin(q(1))*sin(q(2)))*(ab(2) - acc(2) + an(2)) - (sin(q(1))*sin(q(3)) + cos(q(1))*cos(q(3))*sin(q(2)))*(ab(3) - acc(3) + an(3)) - cos(q(2))*cos(q(3))*(ab(1) - acc(1) + an(1)), 0, 0, 0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0, -cos(q(2))*sin(q(3)), - cos(q(1))*cos(q(3)) - sin(q(1))*sin(q(2))*sin(q(3)),   cos(q(3))*sin(q(1)) - cos(q(1))*sin(q(2))*sin(q(3));
0, 0, 0,                                                                                                                                                                                                                                             cos(q(2))*sin(q(1))*(ab(3) - acc(3) + an(3)) - cos(q(1))*cos(q(2))*(ab(2) - acc(2) + an(2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            cos(q(2))*(ab(1) - acc(1) + an(1)) + cos(q(1))*sin(q(2))*(ab(3) - acc(3) + an(3)) + sin(q(1))*sin(q(2))*(ab(2) - acc(2) + an(2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   0, 0, 0, 0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0,          sin(q(2)),                            -cos(q(2))*sin(q(1)),                            -cos(q(1))*cos(q(2));
0, 0, 0,                                                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   0, 0, 0, 0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0,                0,                                           0,                                           0;
0, 0, 0,                                                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   0, 0, 0, 0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0,                0,                                           0,                                           0;
0, 0, 0,                                                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   0, 0, 0, 0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0,                0,                                           0,                                           0;
0, 0, 0,                                                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   0, 0, 0, 0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0,                0,                                           0,                                           0;
0, 0, 0,                                                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   0, 0, 0, 0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0,                0,                                           0,                                           0;
0, 0, 0,                                                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   0, 0, 0, 0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0,                0,                                           0,                                           0];

 
Ut = [-1,  0,  0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0,                0,                                           0,                                           0, 0, 0, 0, 0, 0, 0;
 0, -1,  0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0,                0,                                           0,                                           0, 0, 0, 0, 0, 0, 0;
 0,  0, -1,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0,                0,                                           0,                                           0, 0, 0, 0, 0, 0, 0;
 0,  0,  0,      -(cos(q(1))*cos(q(2))*sin(q(3))^2 + cos(q(1))*cos(q(3))^2*sin(q(2)) + cos(q(2))*cos(q(3))^2*sin(q(2)) + cos(q(3))*sin(q(1))*sin(q(3)) - cos(q(2))*cos(q(3))*sin(q(1))*sin(q(2))*sin(q(3)))/cos(q(2)),             -(sin(q(1))*sin(q(3))^2 + cos(q(2))*cos(q(3))^2*sin(q(1))*sin(q(2)) - cos(q(1))*cos(q(2))*cos(q(3))*sin(q(3)) + cos(q(1))*cos(q(3))*sin(q(2))*sin(q(3)) + cos(q(2))*cos(q(3))*sin(q(2))*sin(q(3)))/cos(q(2)), -cos(q(2))*cos(q(3)),                0,                                           0,                                           0, 0, 0, 0, 0, 0, 0;
 0,  0,  0, (cos(q(3))^2*sin(q(1)) + cos(q(2))*sin(q(1))*sin(q(2))*sin(q(3))^2 + cos(q(1))*cos(q(2))*cos(q(3))*sin(q(3)) - cos(q(1))*cos(q(3))*sin(q(2))*sin(q(3)) - cos(q(2))*cos(q(3))*sin(q(2))*sin(q(3)))/cos(q(2)), -(cos(q(2))*sin(q(2)) + cos(q(1))*cos(q(2))*cos(q(3))^2 - cos(q(2))*cos(q(3))^2*sin(q(2)) + cos(q(1))*sin(q(2))*sin(q(3))^2 - cos(q(3))*sin(q(1))*sin(q(3)) + cos(q(2))*cos(q(3))*sin(q(1))*sin(q(2))*sin(q(3)))/cos(q(2)), -cos(q(2))*sin(q(3)),                0,                                           0,                                           0, 0, 0, 0, 0, 0, 0;
 0,  0,  0,                                                                           (cos(q(3)) - cos(q(2))^2*cos(q(3)) + cos(q(2))^2*sin(q(1))*sin(q(3)) - cos(q(1))*cos(q(2))*cos(q(3)))/cos(q(2)),                                                                                       -(cos(q(2))^2*sin(q(3)) - sin(q(3)) + cos(q(2))^2*cos(q(3))*sin(q(1)) + cos(q(1))*cos(q(2))*sin(q(3)))/cos(q(2)),          sin(q(2)),                0,                                           0,                                           0, 0, 0, 0, 0, 0, 0;
 0,  0,  0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0, -cos(q(2))*cos(q(3)),   cos(q(1))*sin(q(3)) - cos(q(3))*sin(q(1))*sin(q(2)), - sin(q(1))*sin(q(3)) - cos(q(1))*cos(q(3))*sin(q(2)), 0, 0, 0, 0, 0, 0;
 0,  0,  0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0, -cos(q(2))*sin(q(3)), - cos(q(1))*cos(q(3)) - sin(q(1))*sin(q(2))*sin(q(3)),   cos(q(3))*sin(q(1)) - cos(q(1))*sin(q(2))*sin(q(3)), 0, 0, 0, 0, 0, 0;
 0,  0,  0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0,          sin(q(2)),                            -cos(q(2))*sin(q(1)),                            -cos(q(1))*cos(q(2)), 0, 0, 0, 0, 0, 0;
 0,  0,  0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0,                0,                                           0,                                           0, 1, 0, 0, 0, 0, 0;
 0,  0,  0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0,                0,                                           0,                                           0, 0, 1, 0, 0, 0, 0;
 0,  0,  0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0,                0,                                           0,                                           0, 0, 0, 1, 0, 0, 0;
 0,  0,  0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0,                0,                                           0,                                           0, 0, 0, 0, 1, 0, 0;
 0,  0,  0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0,                0,                                           0,                                           0, 0, 0, 0, 0, 1, 0;
 0,  0,  0,                                                                                                                                                                     0,                                                                                                                                                                                  0,                0,                0,                                           0,                                           0, 0, 0, 0, 0, 0, 1];
 
size(At)
size(Ut)
Ft = eye(15) + dt*At;
Vt = Ut;
Qd = Q*dt;

uEst = uPrev + dt*xd;
covarEst = Ft*covarPrev*transpose(Ft) + Vt*Qd*transpose(Vt);



end

